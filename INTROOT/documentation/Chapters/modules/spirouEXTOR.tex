
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\clearpage
\newpage
\begin{minipage}{\textwidth}
\section{The spirouEXTOR module}
\label{ch:the_module:spirouEXTOR}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
\subsection{Extraction}

Defined in \spirouEXTOR\path{.spirouEXTOR.extract_wrapper}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.Extraction(image, pos, sig, **kwargs)
spirouEXTOR.spirouEXTOR.extract_wrapper(image, pos, sig, **kwargs)
\end{pythonbox}

\begin{pythondocstring}
Extraction wrapper - takes in image, pos, sig and kwargs and decides
which extraction process to use.

:param image: numpy array (2D), the image
:param pos: numpy array (1D), the position fit coefficients
            size = number of coefficients for fit
:param sig: numpy array (1D), the width fit coefficients
            size = number of coefficients for fit
:param kwargs: additional keyword arguments

currently accepted keyword arguments are:

    extopt:         int, Extraction option in tilt file:
                     if 0 extraction by summation over constant range
                     if 1 extraction by summation over constant sigma
                        (not currently available)
                     if 2 Horne extraction without cosmic elimination
                        (not currently available)
                     if 3 Horne extraction with cosmic elimination
                        (not currently available)

    nbsig:          float,  distance away from center to extract out to +/-
                    defaults to p['nbsig'] from constants_SPIROU.py

    gain:           float, gain of the image
                    defaults to p['gain'] from fitsfilename HEADER

    sigdet:         float, the sigdet of the image
                    defaults to p['sigdet'] from fitsfilename HEADER

    range1:         float, Half-zone extraction width left side
                    (formally plage1)
                    defaults to p['ic_ext_range1'] from fiber parameters in
                    constatns_SPIROU.txt

    range2:         float, Half-zone extraction width left side
                    (formally plage2)
                    defaults to p['ic_ext_range2'] from fiber parameters in
                    constatns_SPIROU.txt

    tilt:           numpy array (1D), the tilt for this order, if defined
                    uses tilt, if not defined does not
\end{pythondocstring}
\end{minipage}

\begin{minipage}{\textwidth}
\begin{pythondocstring}
Extraction wrapper (continued)

currently accepted keyword arguments are: (continued)

    use_weight:    bool, if True use weighted extraction, if False or not
                    defined does not use weighted extraction

    order_profile:  numpy array (2D), the image with fit superposed on top,
                    required for tilt and or weighted fit

    mode:           if use_weight and tilt is not None then
                    if mode = 'old'  will use old code (use this if
                    exception generated)
                    extract_tilt_weight_order_old() is run

                    else mode = 'new' and
                    extract_tilt_weight_order() is run

:return spe: numpy array (1D), the extracted pixel values,
             size = image.shape[1] (along the order direction)
:return nbcos: int, zero in this case
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------
\begin{minipage}{\textwidth}
\subsection{ExtractABOrderOffset}

Defined in \spirouEXTOR\path{.spirouEXTOR.extract_AB_order}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.ExtractABOrderOffset(pp, loc, image, rnum)
spirouEXTOR.spirouEXTOR.extract_AB_order(pp, loc, image, rnum)
\end{pythonbox}

\begin{pythondocstring}
Perform the extraction on the AB fibers separately using the summation
over constant range

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            IC_CENT_COL: int, the column number (x-axis) of the central
                         column
            IC_FACDEC: float, the offset multiplicative factor for width
            IC_EXTOPT: int, the extraction option
            gain: float, the gain of the image
            IC_EXTNBSIG: float, distance away from center to extract
                         out to +/- (in rows or y-axis direction)

:param loc: parameter dictionary, ParamDict containing data
        Must contain at least:
            ass: numpy array (2D), the fit coefficients array for
                  the widths fit
                  shape = (number of orders x number of fit coefficients)
            acc: numpy array (2D), the fit coefficients array for
                  the centers fit
                  shape = (number of orders x number of fit coefficients)


:param image: numpy array (2D), the image
:param rnum: int, the order number for this iteration

:return loc: parameter dictionary, the updated parameter dictionary
        Adds/updates the following:
            offset: numpy array (1D), the center values with the
                    offset in 'IC_CENT_COL' added
            cent1: numpy array (2D), the extraction for A, updated is
                   the order "rnum"
            nbcos: int, 0 (constant)
            cent2: numpy array (2D), the extraction for B, updated is
                   the order "rnum"
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------
\begin{minipage}{\textwidth}
\subsection{ExtractOrder}

Defined in \spirouEXTOR\path{.spirouEXTOR.extract_order}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.ExtractOrder(pp, loc, image, rnum, **kwargs)
spirouEXTOR.spirouEXTOR.extract_order(pp, loc, image, rnum, **kwargs)
\end{pythonbox}

\begin{pythondocstring}
Extract order without tilt or weight using spirouEXTOR.extract_wrapper()

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            IC_EXTOPT: int, the extraction option
            IC_EXT_RANGE: float, the upper and lower edge of the order
                          in rows (y-axis) - half-zone width
            gain: float, the gain of the image

:param loc: parameter dictionary, ParamDict containing data
        Must contain at least:
            acc: numpy array (2D), the fit coefficients array for
                  the centers fit
                  shape = (number of orders x number of fit coefficients)
            ass: numpy array (2D), the fit coefficients array for
                  the widths fit
                  shape = (number of orders x number of fit coefficients)

:param image: numpy array (2D), the image
:param rnum: int, the order number for this iteration
:param kwargs: additional keywords to pass to the extraction wrapper

        - allowed keywords are:

        range1  (defaults to "IC_EXT_RANGE")
        range2  (defaults to "IC_EXT_RANGE")
        gain    (defaults to "GAIN")

:return cent: numpy array (1D), the extracted pixel values,
             size = image.shape[1] (along the order direction)
:return cpt: int, zero in this case
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\begin{minipage}{\textwidth}
\subsection{ExtractTiltOrder}

Defined in \spirouEXTOR\path{.spirouEXTOR.extract_tilt_order}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.ExtractTiltOrder(pp, loc, image, rnum, **kwargs)
spirouEXTOR.spirouEXTOR.extract_tilt_order(pp, loc, image, rnum, **kwargs)
\end{pythonbox}

\begin{pythondocstring}
Extract order with tilt but without weight using
spirouEXTOR.extract_wrapper()

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            IC_EXT_RANGE: float, the upper and lower edge of the order
                          in rows (y-axis) - half-zone width
            gain: float, the gain of the image

:param loc: parameter dictionary, ParamDict containing data
        Must contain at least:
            acc: numpy array (2D), the fit coefficients array for
                  the centers fit
                  shape = (number of orders x number of fit coefficients)
            ass: numpy array (2D), the fit coefficients array for
                  the widths fit
                  shape = (number of orders x number of fit coefficients)
            tilt: numpy array (1D), the tilt angle of each order

:param image: numpy array (2D), the image
:param rnum: int, the order number for this iteration
:param kwargs: additional keywords to pass to the extraction wrapper

        - allowed keywords are:

        range1  (defaults to "IC_EXT_RANGE")
        range2  (defaults to "IC_EXT_RANGE")
        gain    (defaults to "GAIN")

:return cent: numpy array (1D), the extracted pixel values,
             size = image.shape[1] (along the order direction)
:return cpt: int, zero in this case
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\begin{minipage}{\textwidth}
\subsection{ExtractTiltWeightOrder}

Defined in \spirouEXTOR\path{.extract_tilt_weight_order}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.ExtractTiltWeightOrder(pp, loc, image, orderp, rnum, **kwargs)
spirouEXTOR.spirouEXTOR.extract_tilt_weight_order(pp, loc, image, orderp, rnum, **kwargs)
\end{pythonbox}

\begin{pythondocstring}
Extract order with tilt and weight using
spirouEXTOR.extract_wrapper() with mode=1
(extract_tilt_weight_order_old() is run)

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            IC_EXT_RANGE: float, the upper and lower edge of the order
                          in rows (y-axis) - half-zone width
            gain: float, the gain of the image
            sigdet: float, the read noise of the image

:param loc: parameter dictionary, ParamDict containing data
        Must contain at least:
            acc: numpy array (2D), the fit coefficients array for
                  the centers fit
                  shape = (number of orders x number of fit coefficients)
            ass: numpy array (2D), the fit coefficients array for
                  the widths fit
                  shape = (number of orders x number of fit coefficients)
            tilt: numpy array (1D), the tilt angle of each order

:param image: numpy array (2D), the image
:param orderp: numpy array (2D), the order profile image
:param rnum: int, the order number for this iteration
:param kwargs: additional keywords to pass to the extraction wrapper

        - allowed keywords are:

        range1  (defaults to "IC_EXT_RANGE")
        range2  (defaults to "IC_EXT_RANGE")
        gain    (defaults to "GAIN")
        sigdet  (defaults to "SIGDET")

:return cent: numpy array (1D), the extracted pixel values,
             size = image.shape[1] (along the order direction)
:return cpt: int, zero in this case
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\begin{minipage}{\textwidth}
\subsection{ExtractTiltWeightOrder2}

Defined in \spirouEXTOR\path{.}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.ExtractTiltWeightOrder2(pp, loc, image, orderp, rnum, **kwargs)
spirouEXTOR.spirouEXTOR.extract_tilt_weight_order2(pp, loc, image, orderp, rnum, **kwargs)
\end{pythonbox}

\begin{pythondocstring}
Extract order with tilt and weight using
spirouEXTOR.extract_wrapper() with mode=2
(extract_tilt_weight_order() is run)

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            IC_EXT_RANGE1: float, the upper edge of the order in rows
                           (y-axis) - half-zone width (lower)
            IC_EXT_RANGE2: float, the lower edge of the order in rows
                           (y-axis) - half-zone width (upper)
            gain: float, the gain of the image
            sigdet: float, the read noise of the image

:param loc: parameter dictionary, ParamDict containing data
        Must contain at least:
            acc: numpy array (2D), the fit coefficients array for
                  the centers fit
                  shape = (number of orders x number of fit coefficients)
            ass: numpy array (2D), the fit coefficients array for
                  the widths fit
                  shape = (number of orders x number of fit coefficients)
            tilt: numpy array (1D), the tilt angle of each order

:param image: numpy array (2D), the image
:param orderp: numpy array (2D), the order profile image
:param rnum: int, the order number for this iteration
:param kwargs: additional keywords to pass to the extraction wrapper

        - allowed keywords are:

        range1  (defaults to "IC_EXT_RANGE1")
        range2  (defaults to "IC_EXT_RANGE2")
        gain    (defaults to "GAIN")
        sigdet  (defaults to "SIGDET")

:return cent: numpy array (1D), the extracted pixel values,
             size = image.shape[1] (along the order direction)
:return cpt: int, zero in this case
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\begin{minipage}{\textwidth}
\subsection{}

Defined in \spirouEXTOR\path{.}

\begin{pythonbox}
from SpirouDRS import spirou
spirouEXTOR.ExtractWeightOrder(pp, loc, image, orderp, rnum, **kwargs)
spirouEXTOR.spirouEXTOR.extract_weight_order(pp, loc, image, orderp, rnum, **kwargs)
\end{pythonbox}

\begin{pythondocstring}
Extract order with weight but without tilt using
spirouEXTOR.extract_wrapper()

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            IC_EXT_RANGE: float, the upper and lower edge of the order
                          in rows (y-axis) - half-zone width
            gain: float, the gain of the image
            sigdet: float, the read noise of the image

:param loc: parameter dictionary, ParamDict containing data
        Must contain at least:
            acc: numpy array (2D), the fit coefficients array for
                  the centers fit
                  shape = (number of orders x number of fit coefficients)
            ass: numpy array (2D), the fit coefficients array for
                  the widths fit
                  shape = (number of orders x number of fit coefficients)

:param image: numpy array (2D), the image
:param orderp: numpy array (2D), the order profile image
:param rnum: int, the order number for this iteration
:param kwargs: additional keywords to pass to the extraction wrapper

        - allowed keywords are:

        range1  (defaults to "IC_EXT_RANGE")
        range2  (defaults to "IC_EXT_RANGE")
        gain    (defaults to "GAIN")
        sigdet  (defaults to "SIGDET")

:return cent: numpy array (1D), the extracted pixel values,
             size = image.shape[1] (along the order direction)
:return cpt: int, zero in this case
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

