
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\clearpage
\newpage
\noindent\begin{minipage}{\textwidth}
\section{The spirouStartup module}
\label{ch:the_module:spirouStartup}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%----------------------------------------------------------------------------------------
\subsection{Begin}

Defined in \spirouStartup\path{.spirouStartup.run_begin}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.Begin()
spirouStartup.spirouStartup.run_begin()
\end{pythonbox}

\begin{pythondocstring}
Begin DRS - Must be run at start of every recipe
- loads the parameters from the primary configuration file, displays
  title, checks primary constants and displays initial parametrization

:return cparams: parameter dictionary, ParamDict constants from primary
                 configuration file
        Adds the following:
            all constants in primary configuration file
            DRS_NAME: string, the name of the DRS
            DRS_VERSION: string, the version of the DRS
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------
\noindent\begin{minipage}{\textwidth}
\subsection{DisplayTitle}

Defined in \spirouStartup\path{.spirouStartup.display_title}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.DisplayTitle(title)
spirouStartup.spirouStartup.display_title(title)
\end{pythonbox}

\begin{pythondocstring}
Display any title between HEADER bars via the WLOG command

:param title: string, title string

:return None:
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------
\noindent\begin{minipage}{\textwidth}
\subsection{DisplaySysInfo}

Defined in \spirouStartup\path{.spirouStartup.display_system_info}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.DisplaySysInfo()
spirouStartup.spirouStartup.display_system_info()
\end{pythonbox}

\begin{pythondocstring}
Display system information via the WLOG command

:param logonly: bool, if True will only display in the log (not to screen)
                default=True, if False prints to both log and screen

:return None:
\end{pythondocstring}
\end{minipage}


%----------------------------------------------------------------------------------------
\noindent\begin{minipage}{\textwidth}
\subsection{GetCustomFromRuntime}

Defined in \spirouStartup\path{.spirouStartup.get_custom_from_run_time_args}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.GetCustomFromRuntime(positions=None, types=None, names=None,
                                   required=None, calls=None, cprior=None,
                                   lognames=None, last_multi=False):
spirouStartup.spirouStartup.get_custom_from_run_time_args(positions=None, types=None, names=None,
                                   required=None, calls=None, cprior=None,
                                   lognames=None, last_multi=False):
\end{pythonbox}

\begin{pythondocstring}
Extract custom arguments from defined positions in sys.argv (defined at
run time)

:param positions: list of integers or None, the positions of the arguments
                  (i.e. first argument is 0)

:param types: list of python types or None, the type (i.e. int, float) for
              each argument. Note if last_multi = True, the type of the
              last defined parameter should be the type of each argument
              (but the output parameter will be a list of this type of
              arguments)

:param names: list of strings, the names of each argument (to access in
              parameter dictionary once extracted)

:param required: list of bools or None, states whether the program
                 should exit if runtime argument not found

:param calls: list of objects or None, if define these are the values that
              come from a function call (overwrite command line arguments)

:param cprior: list of bools, if True the call takes priority over arguments
               defined at run time, if False run time arguments take
               priority

:param lognames: list of strings, the names displayed in the log (on error)
                 theses should be similar to "names" but in a form the
                 user can easily understand for each variable

:param last_multi: bool, if True then last argument in positions/types/
                   names adds all additional arguments into a list

:return values: dictionary, if run time arguments are correct python type
                the name-value pairs are returned
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------
\noindent\begin{minipage}{\textwidth}
\subsection{GetFile}

Defined in \spirouStartup\path{.spirouStartup.get_file}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.GetFile(p, path, name=None, prefixes=None, kind=None)
spirouStartup.spirouStartup.get_file(p, path, name=None, prefixes=None, kind=None)
\end{pythonbox}

\begin{pythondocstring}
  Get full file path and check the path and file exist

  :param p: parameter dictionary, ParamDict containing constants
      Must contain at least:
              log_opt: string, log option, normally the program name
              program: string, the recipe/way the script was called
                       i.e. from sys.argv[0]

  :param path: string, either the directory to the folder (if name is None) or
               the full path to the file
  :param name: string or None, the name of the file, if None name is assumed
               to be in path
  :param prefixes: string, list of strings or None, if not None this
                   substring must be in the filename
  :param kind: string or None, the type of file (for logging)

  :return location: string, the full file path of the file
\end{pythondocstring}
\end{minipage}


%----------------------------------------------------------------------------------------
\noindent\begin{minipage}{\textwidth}
\subsection{GetFiles}

Defined in \spirouStartup\path{.spirouStartup.get_files}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.GetFiles(p, path, names, prefixes=None, kind=None)
spirouStartup.spirouStartup.get_files(p, path, names, prefixes=None, kind=None)
\end{pythonbox}

\begin{pythondocstring}
  Get a set of full file path and check the path and file exist
  (wrapper around get_files)

  :param p: parameter dictionary, ParamDict containing constants
      Must contain at least:
              log_opt: string, log option, normally the program name
              program: string, the recipe/way the script was called
                       i.e. from sys.argv[0]

  :param path: string, either the directory to the folder (if name is None) or
               the full path to the files
  :param names: list of strings, the names of the files
  :param prefixes: string, list of strings or None, if not None this
                   substring must be in the filenames
  :param kind: string or None, the type of files (for logging)

  :return locations: list of strings, the full file paths of the files
\end{pythondocstring}
\end{minipage}



%----------------------------------------------------------------------------------------

\noindent\begin{minipage}{\textwidth}
\subsection{GetFiberType}

Defined in \spirouStartup\path{.spirouStartup.get_fiber_type}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.GetFiberType(p, filename, fibertypes=None)
spirouStartup.spirouStartup.get_fiber_type(p, filename, fibertypes=None)
\end{pythonbox}

\begin{pythondocstring}
Get fiber types and search for a valid fiber type in filename

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            FIBER_TYPES: list of strings, the types of fiber available
                         (i.e. ['AB', 'A', 'B', 'C'])
            log_opt: string, log option, normally the program name

:param filename: string, the filename to search for fiber types in
:param fibertypes: list of strings, the fiber types to search for

:return fiber: string, the fiber found (exits via WLOG if no fiber found)
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\noindent\begin{minipage}{\textwidth}
\subsection{LoadArguments}

Defined in \spirouStartup\path{.spirouStartup.load_arguments}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.LoadArguments(cparams, night_name=None, files=None, customargs=None)
spirouStartup.spirouStartup.load_arguments(cparams, night_name=None, files=None, customargs=None)
\end{pythonbox}

\begin{pythondocstring}
Deal with loading run time arguments:

1) display help file (if requested and exists)
2) loads run time arguments (and custom arguments, see below)
3) loads other config files

:param cparams: parameter dictionary, ParamDict containing constants

:param night_name: string or None, the name of the directory in DRS_DATA_RAW
                   to find the files in

                   if None (undefined) uses the first argument in command
                   line (i.e. sys.argv[1])

                   if defined overwrites call from
                   command line (i.e. overwrites sys.argv)

                   stored in p['arg_night_name']

:param files: list of strings or None, the files to use for this program

              if None (undefined) uses the second and all other arguments in
              the command line (i.e. sys.argv[2:])

              if defined overwrites call from command line

              stored in p['arg_file_names']

:param customargs: None or list of strings, if list of strings then instead
                   of getting the standard runtime arguments

       i.e. in form:

            program.py rawdirectory arg_file_names[0] arg_file_names[1]...

       loads all arguments into customargs

       i.e. if customargs = ['rawdir', 'filename', 'a', 'b', 'c']
       expects command line arguments to be:

            program.py rawdir filename a b c

:param mainfitsfile: string or None, if "customargs" is not None (i.e. if we
                     are using custom arguments) we must define one
                     of the parameters in "customargs" to be the main fits
                     file (fitsfilename and arg_file_names[0]).
                     The parameter MUST be a string, a fits file,
                     and have HEADER key defining the acquisition time
                     as defined in kw_ACQTIME_KEY in spirouKeywords.py
                     if not using custom arguments (i.e. customargs=None
                     files must be defined and these files are used
                     set fitsfilename and arg_file_names
                     
:param mainfitsdir: string or None, if mainfitsfile is defined and needed
                    this is the location of the mainfitsfile if None this
                    is assumed to be the raw dir folder
                    current other options are:
                        'reduced' - the DRS_DATA_REDUC folder
                        'calibdb' - the DRS_CALIB_DB folder
                        or the full path to the file

:return p: dictionary, parameter dictionary
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\noindent\begin{minipage}{\textwidth}
\subsection{InitialFileSetup}

Defined in \spirouStartup\path{.spirouStartup.initial_file_setup}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.InitialFileSetup(p, kind=None, prefixes=None, add_to_p=None,
                               contains=None, calibdb=False)
spirouStartup.spirouStartup.initial_file_setup(p, kind=None, prefixes=None, add_to_p=None,
                                               contains=None, calibdb=False)

\begin{pythondocstring}
Run start up code (based on program and parameters defined in p before)

:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            log_opt: string, log option, normally the program name
            fitsfilename: string, the full path of for the main raw fits
                          file for a recipe
                          i.e. /data/raw/20170710/filename.fits
            arg_file_names: list, list of files taken from the command line
                            (or call to recipe function) must have at least
                            one string filename in the list
            program: string, the recipe/way the script was called
                     i.e. from sys.argv[0]
            reduced_dir: string, the reduced data directory
                         (i.e. p['DRS_DATA_REDUC']/p['arg_night_name'])
            DRS_DATA_REDUC: string, the directory that the reduced data
                            should be saved to/read from
            DRS_CALIB_DB: string, the directory that the calibration
                          files should be saved to/read from

:param kind: string, description of program we are running (i.e. dark)

:param prefixes: list of strings, prefixes to look for in file name
:param prefixes: list of strings, prefixes to look for in file name
                 will exit code if none of the prefixes are found
                 (prefix = None if no prefixes are needed to be found)

:param add_to_p: dictionary structure:

        add_to_p[prefix1] = dict(key1=value1, key2=value2)
        add_to_p[prefix2] = dict(key3=value3, key4=value4)

        where prefix1 and prefix2 are the strings in "prefixes"

        This will add the sub dictionaries to the main parameter dictionary
        based on which prefix is found

        i.e. if prefix1 is found key "value3" and "value4" above are added
        (with "key3" and "key4") to the parameter dictionary p

:param contains: string or None: if not None then input files must contain
                 this sub string else error is raised

:param calibdb: bool, if True calibDB folder and files are required and
                program will log and exit if they are not found
                if False, program will create calibDB folder

:return p: parameter dictionary, the updated parameter dictionary
        Adds the following:
            calibDB: dictionary, the calibration database dictionary
            prefixes from add_to_p (see spirouStartup.deal_with_prefixes)
\end{pythondocstring}
\end{minipage}

%----------------------------------------------------------------------------------------

\noindent\begin{minipage}{\textwidth}
\subsection{LoadCalibDB}

Defined in \spirouStartup\path{.spirouStartup.load_calibdb}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.LoadCalibDB(p, calibdb=True)
spirouStartup.spirouStartup.load_calibdb(p, calibdb=True)
\end{pythonbox}

\begin{pythondocstring}
Load calibration (on start-up) this is loaded by default when
spirouStartup.spirouStartup.initial_file_setup
(spirouStartup.InitialFileSetup) so this is only needed to be run when
InitialFileSetup is not used (i.e. when custom arguments are used)


:param p: parameter dictionary, ParamDict containing constants
    Must contain at least:
            log_opt: string, log option, normally the program name
            DRS_CALIB_DB: string, the directory that the calibration
                          files should be saved to/read from
:param calibdb: bool, whether to load the calibration database (if False
                just makes sure DRS_CALIB_DB exists (and creates it if it
                doesn't)

:return p: parameter dictionary, the updated parameter dictionary
        Adds the following:
            if calibdb is True:
                calibDB: dictionary, the calibration database dictionary
\end{pythondocstring}
\end{minipage}



%----------------------------------------------------------------------------------------

\noindent\begin{minipage}{\textwidth}
\subsection{Exit}

Defined in \spirouStartup\path{.spirouStartup.exit_script}

\begin{pythonbox}
from SpirouDRS import spirouStartup
spirouStartup.Exit(ll)
spirouStartup.spirouStartup.exit_script(ll)
\end{pythonbox}

\begin{pythondocstring}
Exit script for handling interactive endings to sessions (if DRS_PLOT is
active)

:param ll: dict, the local variables

:return None:
\end{pythondocstring}
\end{minipage}