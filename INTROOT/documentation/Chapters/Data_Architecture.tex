%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\chapter{Data Architecture}
\label{ch:data_architecture}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Described below is the file structure, after correct installation (Chapter \ref{chapter:installation}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\section{Installed file structure}
\label{ch:data_architecture:folder_layout}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The file structure should look as follows:
\begin{tcustomdir}
\customdirtree{%
.1 \{dir\}.
.2 \{DRS\_ROOT\}.
.3 bin \DTcomment{Recipes}.
.3 config \DTcomment{Configuration files}.
.3 documentation \DTcomment{Documentation files}.
.3 man \DTcomment{Manual files}.
.3 misc \DTcomment{Other scripts}.
.3 SpirouDRS \DTcomment{The DRS Module}.
.1 \{TDATA\}*.
.2 calibDB.
.2 msg
.2 raw \DTcomment{Observation directories}.
.3 YYYYMMDD \DTcomment{Raw observation files}. 
.2 reduced.
.2 tmp.
}
\vspace{0.5cm}
\noindent * This is the recommended file structure and raw, reduced, calibDB, msg and tmp can be changed using the \definevariable{text:drs_data_raw}{DRS\_DATA\_RAW}, \definevariable{text:drs_data_reduc}{DRS\_DATA\_REDUC}, \definevariable{text:drs_calib_db}{DRS\_CALIB\_DB}, \definevariable{text:drs_data_msg}{DRS\_DATA\_MSG}, and \definevariable{text:drs_data_working}{DRS\_DATA\_WORKING} variables in Section \ref{ch:install:setup}.
\end{tcustomdir}

\noindent i.e. for the paths given in Section \ref{ch:install:setup} this would be:
\begin{tcustomdir}
\customdirtree{%
.1 drs.
.2 INTROOT.
.3 bin.
.3 config.
.3 documentation.
.3 man.
.3 misc.
.3 SpirouDRS.
.2 data.
.3 calibDB.
.3 msg.
.3 raw.
.4 YYYYMMDD.
.3 reduced.
.3 tmp.
}
\end{tcustomdir}

\clearpage
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\section{The Installation root directory}
\label{ch:data_architecture:install_root_folder}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The \definevariable{text:drs_root}{DRS\_ROOT} contains all the installed recipes, modules functions, documentation and configuration files needed to run the DRS. The file structure is set up as below: 

\begin{tcustomdir}
\customdirtree{%
.1 \{dir\}.
.2 \{DRS\_ROOT\}.
.3 bin \DTcomment{Recipes}.
.3 config \DTcomment{Configuration files}.
.3 documentation \DTcomment{Documentation files}.
.3 SpirouDRS \DTcomment{The DRS Module}.
}
\end{tcustomdir}

% ------------------------------------------------------------------------
\subsection{The bin directory}
\label{ch:data_architecture:install_root_folder:bin_folder}
% ------------------------------------------------------------------------

The bin directory is located in the \definevariable{text:drs_root}{DRS\_ROOT} directory. This contains all the recipes that can be used. A detailed description of all recipes can be found in Chapter \ref{ch:the_recipes} but are listed here for completeness.

\begin{tcustomdir}
\customdirtree{%
.1 \{dir\}.
.2 \{DRS\_ROOT\}.
.3 bin \DTcomment{Recipes}.
.4 \calbadpix \DTcomment{See Section \ref{ch:the_recipes:cal_BADPIX_spirou}}.
.4 \calCCF \DTcomment{See Section \ref{ch:the_recipes:cal_CCF_E2DS_spirou}}.
.4 \calDARK \DTcomment{See Section \ref{ch:the_recipes:cal_DARK_spirou}}.
.4 \calDRIFTE \DTcomment{See Section \ref{ch:the_recipes:cal_DRIFT_RAW_spirou}}.
.4 \calDRIFTPEAK \DTcomment{See Section \ref{ch:the_recipes:cal_DRIFT_RAW_spirou}}.
.4 \calexometer.
.4 \calextractRAW \DTcomment{See Section \ref{ch:the_recipes:cal_extract_RAW_spirou}}.
.4 \calextractRAWAB \DTcomment{See Section \ref{ch:the_recipes:cal_extract_RAW_spirou}}.
.4 \calextractRAWC \DTcomment{See Section \ref{ch:the_recipes:cal_extract_RAW_spirou}}.
.4 \calFFraw \DTcomment{See Section \ref{ch:the_recipes:cal_FF_RAW_spirou}}.
.4 \calHC \DTcomment{See Section \ref{ch:the_recipes:cal_HC_E2DS_spirou}}.
.4 \callocRAW \DTcomment{See Section \ref{ch:the_recipes:cal_loc_RAW_spirou}}.
.4 \calpreprocess.
.4 \calreset.
.4 \calSLIT \DTcomment{See Section \ref{ch:the_recipes:cal_SLIT_spirou}}.
.4 \calvalidate \DTcomment{See Section \ref{ch:the_recipes:cal_validate_spirou}}.
.4 \calWAVE \DTcomment{See Section \ref{ch:the_recipes:cal_WAVE_E2DS_spirou}}.
.4 \offlisting.
.4 \polspirou.
.4 \visuEDS.
.4 \visuRAW.
.4 \visuWAVE.
}
\end{tcustomdir}



% only show this section is developer guide
\clearpage
\newpage
\ifdevguide

% ------------------------------------------------------------------------
\subsection{The SPIROU module directory}
\label{ch:data_architecture:install_root_folder:module_folder}
% ------------------------------------------------------------------------

The SpirouDRS directory is the SPIROU DRS package, it contains all sub-packages that contain all the worker functions and code associated with the recipes. The modules are described in detail in Chapter \ref{ch:the_module}. \\

The file structure is as follows:

\begin{tcustomdir}
\customdirtree{%
.1 SpirouDRS.
.2 data \DTcomment{The DRS data directory}.
.2 fortran \DTcomment{The Fortran script directory}.
.2 spirouBACK \DTcomment{The SPIRou background module (Section \ref{ch:the_module:spirouBACK})}.
.2 spirouDB \DTcomment{The SPIRou calibration database module (Section \ref{ch:the_module:spirouCDB})}.
.2 spirouConfig \DTcomment{The SPIRou configuration tools module (Section \ref{ch:the_module:spirouConfig})}.
.2 spirouCore \DTcomment{The SPIRou core modules (Section \ref{ch:the_module:spirouCore})}.
.2 spirouEXTOR \DTcomment{The SPIRou extraction module (Section \ref{ch:the_module:spirouEXTOR})}.
.2 spirouFLAT \DTcomment{The SPIRou Flat field module (Section \ref{ch:the_module:spirouFLAT})}.
.2 spirouImage \DTcomment{The SPIRou image module (Section \ref{ch:the_module:spirouImage})}.
.2 spirouLOCOR \DTcomment{The SPIRou localization module (Section \ref{ch:the_module:spirouLOCOR})}.
.2 spirouPOLAR \DTcomment{The SPIRou polarization module}.
.2 spirouRV \DTcomment{The SPIRou radial velocity module (Section \ref{ch:the_module:spirouRV})}.
.2 spirouStartup \DTcomment{The SPIRou start up tools module (Section \ref{ch:the_module:spirouStartup})}.
.2 spirouTHORCA \DTcomment{The SPIRou THORCA module (Section \ref{ch:the_module:spirouTHORCA})}.
.2 spirouTools \DTcomment{The SPIRou tools module}.
.2 spirouUnitTests \DTcomment{The SPIRou unit tests module}.
}
\end{tcustomdir}



% end developer guide only
\fi

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\section{The data root directory}
\label{ch:data_architecture:data_root_folder}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This is the directory where all the data should be stored. The default and recommended design is to have\definevariable{text:drs_data_raw}{DRS\_DATA\_RAW}, \definevariable{text:drs_data_reduc}{DRS\_DATA\_REDUC}, \definevariable{text:drs_calib_db}{DRS\_CALIB\_DB}, \definevariable{text:drs_data_msg}{DRS\_DATA\_MSG}, and \definevariable{text:drs_data_working}{DRS\_DATA\_WORKING} as sub-directories of \definevariable{text:drs_root}{DRS\_ROOT}. However as in Section \ref{ch:install:setup}. these sub-directories can be defined elsewhere.

% ------------------------------------------------------------------------
\subsection{The raw and reduced data directories}
\label{ch:data_architecture:data_root_folderraw_folder}
% ------------------------------------------------------------------------
The raw observed data is stored under the \definevariable{text:drs_data_raw}{DRS\_DATA\_RAW} path, the files are stored by night in the form \constantFolderDateFormat. \\

\noindent The file structure can be seen below:
\begin{tcustomdir}
\customdirtree{%
.1 \{DRS\_DATA\_RAW\}.
.2 YYYYMMDD \DTcomment{night\_repository}.
.3 \DTcomment{Raw observation files}. 
.3 \{odometer number\}d.fits.
.3 \{odometer number\}f.fits.
.3 \{odometer number\}a.fits.
.3 \{odometer number\}c.fits.
.3 \{odometer number\}o.fits.
}
\end{tcustomdir}

where d=dark, f=flat, a=align, c=comparison and o=object

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
\clearpage
\newpage
\section{The calibration database directory}
\label{ch:data_architecture:calibDB}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{tcustomdir}
\customdirtree{%
.1 \{TDATA\}.
.2 calibDB or \{DRS\_CALIB\_DB\}.
.3 master\_calib\_SPIROU.txt.
.3 \DTcomment{The calibration fits files}. 
}
\end{tcustomdir}
\noindent The calibDB contains all the calibration files that pass the quality tests and a test file \masterCALIBDBfile. It is located at \definevariable{text:drs_calib_db}{DRS\_CALIB\_DB} or if this is not defined is located by default at the \definevariable{text:tdata}{TDATA} directory.

\noindent Each line in this file is a unique calibration file and lines are formatted in the following manner:

\begin{textbox}[title={In calibration database file}]
@{key}@ @{night_repository}@ @{filename}@ @{human readable date}@ @{unix time}@ 
\end{textbox}
\begin{thighlight}
\noindent where
\begin{itemize}
\item \defineskeyword{key} is a code assigned for each type of calibration file. Currently accepted keys are:
\begin{itemize}
\item DARK - Created from \calDARK
\item ORDER\_PROFIL\_\definevariable{text:fiber_types}{fiber} - Created in \callocRAW
\item LOC\_C - Created in \callocRAW
\item TILT - Created in \calSLIT
\item FLAT\_\definevariable{text:fiber_types}{fiber} - Created in \calFFraw
\item WAVE - Currently manually added
\end{itemize}

\item \defineskeyword{night\_repository} is the raw data observation directory (in \definevariable{text:drs_data_raw}{DRS\_DATA\_RAW}) normally in the form \constantFolderDateFormat.

\item \defineskeyword{filename} is the filename of the calibration file (located in the calibDB).

\item \defineskeyword{human readable date} is the date in DD/MM/YY/HH:MM:SS.ss format taken from the header keyword `\constantAcqtimeKey' of the file that created the calibration file.

\item \defineskeyword{unix time} is the time (as in \defineskeyword{human readable date}) but in unix time (in seconds).

\end{itemize}
\end{thighlight}

\noindent An example working \masterCALIBDBfile is shown below (assuming the listed files are present in \definevariable{text:drs_calib_db}{DRS\_CALIB\_DB})
\begin{textbox}[title={In calibration database file}]
@DARK@ 20170710 dark_dark02d406.fits 07/10/17/16:37:48 1499704668.0
@ORDER_PROFIL_C@ 20170710 dark_flat02f10_order_profil_C.fits 07/10/17/17:03:50 1499706230.0
@LOC_C@ 20170710 dark_flat02f10_loco_C.fits 07/10/17/17:03:50 1499706230.0
@ORDER_PROFIL_AB@ 20170710 flat_dark02f10_order_profil_AB.fits 07/10/17/17:07:08 1499706428.0
@LOC_AB@ 20170710 flat_dark02f10_loco_AB.fits 07/10/17/17:07:08 1499706428.0
@TILT@ 20170710 fp_fp02a203_tilt.fits 07/10/17/17:25:15 1499705515.0
@FLAT_C@ 20170710 dark_flat02f10_flat_C.fits 07/10/17/17:03:50 1499706230.0
@WAVE@ 20170710 spirou_wave_ini3.fits 07/10/17/17:03:50 1499706230.0
\end{textbox}
